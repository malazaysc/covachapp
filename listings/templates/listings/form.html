{% extends 'base.html' %}
{% block title %}Listing Editor Â· Covach{% endblock %}
{% block content %}
<section>
  <!-- Breadcrumb -->
  <nav class="text-sm text-neutral-400 mb-6">
    <a href="/host/listings" class="hover:text-blue-600 transition">Listings</a>
    <span class="mx-1.5">/</span>
    <span class="text-neutral-500">{% if mode == 'create' %}New listing{% else %}Edit{% endif %}</span>
  </nav>

  <div class="grid gap-6 lg:grid-cols-3">
    <article class="lg:col-span-2">
      <div class="card p-6">
        <h1 class="font-heading text-3xl font-bold mb-6">{% if mode == 'create' %}Create listing{% else %}Edit listing{% endif %}</h1>
        <form method="post" enctype="multipart/form-data">{% csrf_token %}

          <!-- Basic Info -->
          <div class="mb-8">
            <h2 class="text-sm font-bold uppercase tracking-wider text-neutral-300 mb-4">Basic Info</h2>
            <div class="space-y-1">
              <div class="form-group">
                <label class="form-label" for="id_title">Title</label>
                {{ form.title }}
                {% if form.title.errors %}<p class="form-error">{{ form.title.errors.0 }}</p>{% endif %}
              </div>
              <div class="form-group">
                <label class="form-label" for="id_description">Description</label>
                {{ form.description }}
                {% if form.description.errors %}<p class="form-error">{{ form.description.errors.0 }}</p>{% endif %}
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label" for="id_property_type">Property type</label>
                  {{ form.property_type }}
                </div>
                <div class="form-group">
                  <label class="form-label" for="id_status">Status</label>
                  {{ form.status }}
                </div>
              </div>
            </div>
          </div>

          <!-- Location -->
          <div class="mb-8">
            <h2 class="text-sm font-bold uppercase tracking-wider text-neutral-300 mb-4">Location</h2>
            <div class="space-y-1">
              <div class="form-group">
                <label class="form-label" for="id_street_address">Street address</label>
                {{ form.street_address }}
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label" for="id_city">City</label>
                  {{ form.city }}
                </div>
                <div class="form-group">
                  <label class="form-label" for="id_region">Region</label>
                  {{ form.region }}
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label" for="id_country">Country</label>
                  {{ form.country }}
                </div>
                <div class="form-group">
                  <label class="form-label" for="id_postal_code">Postal code</label>
                  {{ form.postal_code }}
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label" for="id_latitude">Latitude</label>
                  {{ form.latitude }}
                </div>
                <div class="form-group">
                  <label class="form-label" for="id_longitude">Longitude</label>
                  {{ form.longitude }}
                </div>
              </div>
              <div class="rounded-xl border border-neutral-200 overflow-hidden">
                <p class="text-xs font-medium text-neutral-400 px-3 py-2 bg-neutral-50">Click map to set location</p>
                <div id="listing-map" class="h-72"></div>
              </div>
            </div>
          </div>

          <!-- Pricing & Details -->
          <div class="mb-8">
            <h2 class="text-sm font-bold uppercase tracking-wider text-neutral-300 mb-4">Pricing & Details</h2>
            <div class="space-y-1">
              <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label" for="id_nightly_rate_usd">Nightly rate (USD)</label>
                  {{ form.nightly_rate_usd }}
                </div>
                <div class="form-group">
                  <label class="form-label" for="id_cancellation_policy">Cancellation policy</label>
                  {{ form.cancellation_policy }}
                </div>
              </div>
              <div class="grid grid-cols-3 gap-4">
                <div class="form-group">
                  <label class="form-label" for="id_max_guests">Max guests</label>
                  {{ form.max_guests }}
                </div>
                <div class="form-group">
                  <label class="form-label" for="id_bedrooms">Bedrooms</label>
                  {{ form.bedrooms }}
                </div>
                <div class="form-group">
                  <label class="form-label" for="id_bathrooms">Bathrooms</label>
                  {{ form.bathrooms }}
                </div>
              </div>
            </div>
          </div>

          <!-- Amenities -->
          <div class="mb-8">
            <h2 class="text-sm font-bold uppercase tracking-wider text-neutral-300 mb-4">Amenities</h2>
            <div class="form-checkbox-list">
              {% for checkbox in form.amenities %}
                {{ checkbox }}
              {% endfor %}
            </div>
          </div>

          <button class="btn btn-primary btn-lg" type="submit">Save listing</button>
        </form>
      </div>
    </article>

    {% if mode == 'edit' %}
    <aside class="space-y-6">
      <!-- Availability blocks -->
      <div class="card p-6">
        <h2 class="font-heading text-xl font-bold mb-4">Availability blocks</h2>
        <form method="post" class="space-y-3">{% csrf_token %}
          <input type="hidden" name="block_form" value="1">
          <div class="form-group">
            <label class="form-label" for="id_start_date">Start date</label>
            {{ block_form.start_date }}
          </div>
          <div class="form-group">
            <label class="form-label" for="id_end_date">End date</label>
            {{ block_form.end_date }}
          </div>
          <div class="form-group">
            <label class="form-label" for="id_reason">Reason</label>
            {{ block_form.reason }}
          </div>
          <button class="btn btn-secondary w-full" type="submit">Add block</button>
        </form>
        <div class="mt-4 space-y-2">
          {% for block in blocks %}
            <div class="flex items-center gap-2 text-sm rounded-lg bg-neutral-50 px-3 py-2.5">
              <svg class="w-3.5 h-3.5 text-neutral-300 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>
              <span>{{ block.start_date }} &rarr; {{ block.end_date }}{% if block.reason %} <span class="text-neutral-400">&middot; {{ block.reason }}</span>{% endif %}</span>
            </div>
          {% empty %}
            <p class="text-sm text-neutral-400">No blocked dates.</p>
          {% endfor %}
        </div>
      </div>

      <!-- Photos -->
      <div class="card p-6">
        <h2 class="font-heading text-xl font-bold mb-4">Photos</h2>
        <form method="post" enctype="multipart/form-data" class="space-y-3">{% csrf_token %}
          <input type="hidden" name="photo_form" value="1">
          <div class="form-group">
            <label class="form-label" for="id_image">Image</label>
            {{ photo_form.image }}
          </div>
          <div class="form-group">
            <label class="form-label" for="id_caption">Caption</label>
            {{ photo_form.caption }}
          </div>
          <div class="form-group">
            <label class="form-label" for="id_sort_order">Sort order</label>
            {{ photo_form.sort_order }}
          </div>
          <button class="btn btn-secondary w-full" type="submit">Upload photo</button>
        </form>
        <div class="mt-4 space-y-2">
          {% for photo in photos %}
            <div class="flex items-center justify-between rounded-lg bg-neutral-50 px-3 py-2.5 text-sm">
              <span class="truncate">{{ photo.caption|default:'Photo' }}</span>
              <span class="badge badge-gray">#{{ photo.sort_order }}</span>
            </div>
          {% empty %}
            <p class="text-sm text-neutral-400">No photos uploaded.</p>
          {% endfor %}
        </div>
      </div>
    </aside>
    {% endif %}
  </div>
</section>

<script>
(function () {
  var latInput = document.getElementById('id_latitude');
  var lonInput = document.getElementById('id_longitude');
  if (!latInput || !lonInput || !document.getElementById('listing-map')) {
    return;
  }
  var lat = parseFloat(latInput.value || '37.773972');
  var lon = parseFloat(lonInput.value || '-122.431297');
  var map = L.map('listing-map').setView([lat, lon], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  var marker = L.marker([lat, lon]).addTo(map);
  map.on('click', function (event) {
    marker.setLatLng(event.latlng);
    latInput.value = event.latlng.lat.toFixed(6);
    lonInput.value = event.latlng.lng.toFixed(6);
  });
})();
</script>
{% endblock %}
